name: Nightly Build and Publish Samsaadhanii Image

on:
  schedule:
    # Runs every day at 05:47 UTC (11:17 AM IST - less peak time)
    - cron: '47 5 * * *'
  workflow_dispatch:    # Allows manual trigger
    inputs:
        force_build:
          description: 'Force a rebuild even if the image exists?'
          type: boolean
          required: false
          default: false

env:
  # The Upstream Repo you want to track
  UPSTREAM_REPO: "https://github.com/samsaadhanii/scl.git"
  
  # Your Image Names
  IMAGE_NAME: "samsaadhanii"
  DOCKER_HUB_SLUG: ${{ secrets.DOCKER_HUB_USERNAME }}/samsaadhanii
  GHCR_SLUG: ghcr.io/${{ github.repository_owner }}/samsaadhanii

jobs:
  smart_build:
    name: Check, Build, or Retag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Your Repo (with Dockerfile)
        uses: actions/checkout@v3

      - name: Get Upstream Details
        id: upstream
        shell: bash  # Ensure bash for pipefail support
        run: |
          # Enable pipefail so if git fails, the whole step fails
          set -e
          set -o pipefail

          # 1. Get the latest SHA from the upstream remote
          LATEST_SHA=$(git ls-remote ${{ env.UPSTREAM_REPO }} HEAD | awk '{ print $1 }')
          
          # SAFETY CHECK: Stop immediately if SHA is empty
          if [ -z "$LATEST_SHA" ]; then
            echo "::error::Failed to fetch SHA. The variable is empty."
            exit 1
          fi

          SHORT_SHA=${LATEST_SHA:0:7}
          
          # 2. Generate a Date Tag (e.g., 20231027-0200)
          DATE_TAG=$(date +%Y%m%d-%H%M)
          
          echo "Upstream SHA: $SHORT_SHA"
          echo "Date Tag: $DATE_TAG"
          
          # Output variables for next steps
          echo "commit_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "full_sha=$LATEST_SHA" >> $GITHUB_OUTPUT
          echo "date_tag=$DATE_TAG" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Registries
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      
      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if Image Exists
        id: check
        run: |
          # Check if the user requested a forced build
          if [[ "${{ github.event.inputs.force_build }}" == "true" ]]; then
             echo "Manual force build requested. Skipping existence check."
             echo "exists=false" >> $GITHUB_OUTPUT
             exit 0
          fi

          # Standard check (only runs if force_build is NOT true)
          IMAGE_URI="${{ env.DOCKER_HUB_SLUG }}:sha-${{ steps.upstream.outputs.commit_sha }}"
          
          echo "Checking for existing image: $IMAGE_URI"
          
          # We use buildx imagetools inspect. It returns exit code 0 if found, 1 if missing.
          if docker buildx imagetools inspect $IMAGE_URI > /dev/null 2>&1; then
            echo "Image exists!"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Image not found. Needs build."
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # ----------------------------------------------------------------
      # PATH A: The Build (Runs only if image is missing)
      # ----------------------------------------------------------------
      - name: Build and Push New Changes
        if: steps.check.outputs.exists == 'false'
        uses: docker/build-push-action@v3
        with:
          context: .
          push: true
          # To build for arm64 platforms (Apple Silicon, Rasberry Pi, etc.)
          platforms: linux/amd64,linux/arm64
          # We pass the SHA to the Dockerfile in case you need to 'git checkout' inside it
          build-args: |
            UPSTREAM_SHA=${{ steps.upstream.outputs.full_sha }}
          tags: |
            ${{ env.DOCKER_HUB_SLUG }}:latest
            ${{ env.DOCKER_HUB_SLUG }}:sha-${{ steps.upstream.outputs.commit_sha }}
            ${{ env.DOCKER_HUB_SLUG }}:${{ steps.upstream.outputs.date_tag }}
            ${{ env.GHCR_SLUG }}:latest
            ${{ env.GHCR_SLUG }}:sha-${{ steps.upstream.outputs.commit_sha }}
            ${{ env.GHCR_SLUG }}:${{ steps.upstream.outputs.date_tag }}

      # ----------------------------------------------------------------
      # PATH B: The Retag (Runs only if image already exists)
      # ----------------------------------------------------------------
      - name: Retag Existing Image
        if: steps.check.outputs.exists == 'true'
        run: |
          EXISTING_TAG="sha-${{ steps.upstream.outputs.commit_sha }}"
          NEW_DATE_TAG="${{ steps.upstream.outputs.date_tag }}"
          
          echo "Skipping build. Adding new date tag ($NEW_DATE_TAG) to existing image ($EXISTING_TAG)."
          
          # Retag for Docker Hub
          docker buildx imagetools create \
            --tag ${{ env.DOCKER_HUB_SLUG }}:$NEW_DATE_TAG \
            --tag ${{ env.DOCKER_HUB_SLUG }}:latest \
            ${{ env.DOCKER_HUB_SLUG }}:$EXISTING_TAG
            
          # Retag for GHCR
          docker buildx imagetools create \
            --tag ${{ env.GHCR_SLUG }}:$NEW_DATE_TAG \
            --tag ${{ env.GHCR_SLUG }}:latest \
            ${{ env.GHCR_SLUG }}:$EXISTING_TAG

      # ----------------------------------------------------------------
      # REPORTING
      # ----------------------------------------------------------------
      # - name: Email Report
      #   if: always()
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.gmail.com
      #     server_port: 465
      #     username: ${{ secrets.MAIL_USERNAME }}
      #     password: ${{ secrets.MAIL_PASSWORD }}
      #     subject: Docker Job: ${{ steps.check.outputs.exists == 'true' && 'Retagged' || 'Built New' }} Image
      #     to: your-email@example.com
      #     from: GitHub Actions
      #     body: |
      #       Job Status: ${{ job.status }}
      #       Action: ${{ steps.check.outputs.exists == 'true' && 'Quick Retag (No Build)' || 'Full Build' }}
            
      #       Upstream SHA: ${{ steps.upstream.outputs.commit_sha }}
      #       New Tag Generated: ${{ steps.upstream.outputs.date_tag }}
            
      #       View Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
